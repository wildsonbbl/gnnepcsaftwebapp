{% extends "master.html" %}
{% load static %}
{% block title %}
  AI CHAT
{% endblock title %}
{% block content %}
  <div class="col-lg">
    {% if show_form %}
      <form action="" method="post" id="submitGoogleApiKey">
        {% csrf_token %}
        <div class="row my-5 justify-content-center">
          <div class="col-md-6">
            {{ google_api_key_form.google_api_key }}
            <p class="mx-2 my-1">
              You can find more about Gemini API Keys
              <a href="https://ai.google.dev/gemini-api/docs/api-key" target="_blank">here</a>.
              This key is not stored for security reasons.
            </p>
            <input type="submit"
                   value="Submit Gemini API Key"
                   class="form-control btn-outline-primary" />
          </div>
        </div>
      </form>
      <div class="row my-1 justify-content-center">
        <ul>
          {% for error in google_api_key_form.google_api_key.errors %}
            <li class="alert alert-danger">{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <div class="row justify-content-center" id="chatrow">
        <div class="col-12">
          <div class="card chat-card-style bg-light">
            <div id="chat-log" class="card-body overflow-auto">
              <!-- Chat messages will be populated here -->
            </div>
            <div class="row d-flex justify-content-center" id="chat-form-row">
              <form>
                <div id="file-preview-container" class="m-1 p-1 border rounded bg-white"></div>
                <div class="col-12 position-relative">
                  <div class="pt-5 w-100 rounded bg-light position-absolute bottom-0">
                    <!-- Chat textarea bottom buttons will be added on top of here -->
                  </div>
                  <div class="pt-5 w-100 rounded bg-light position-absolute top-0">
                    <!-- Chat textarea top buttons will be added on top of here -->
                  </div>
                  <textarea id="chat-message-input"
                            class="form-control bg-light py-5"
                            placeholder="Write your message here"></textarea>
                  <div class="d-flex position-absolute bottom-0 end-0 m-1">
                    <!-- Chat textarea bottom buttons will be added here -->
                    <div class="dropdown me-2">
                      <button class="btn btn-sm btn-outline-secondary rounded dropdown-toggle"
                              type="button"
                              id="toolsDropdown"
                              data-bs-toggle="dropdown"
                              aria-expanded="false"
                              title="Tools">
                        <i class="fas fa-tools"></i>
                      </button>
                      <ul class="dropdown-menu" id="tools-list" aria-labelledby="toolsDropdown">
                        <!-- Tools will be populated here -->
                      </ul>
                    </div>
                    <button id="activate-mcp-btn"
                            type="button"
                            class="btn btn-sm btn-outline-info rounded me-1"
                            title="Activate MCP Servers">
                      <!-- Title will be updated by JS -->
                      <i class="fas fa-server"></i>
                    </button>
                    <input type="file"
                           id="file-input"
                           class="d-none"
                           title="Upload file input"
                           accept=".pdf,image/*">
                    <button id="attach-file-button"
                            type="button"
                            class="btn btn-sm btn-outline-secondary rounded-circle me-1"
                            title="Attach File">
                      <i class="fas fa-paperclip"></i>
                    </button>
                    <button id="chat-message-submit"
                            type="button"
                            class="btn btn-sm btn-outline-primary rounded-circle"
                            title="Send Message">
                      <i class="fas fa-paper-plane"></i>
                    </button>
                  </div>
                  <div class="d-flex position-absolute top-0 start-0 m-1">
                    <!-- Chat textarea top buttons will be added here -->
                    <div class="m-1">
                      <button id="new-session-btn"
                              class="btn btn-sm btn-outline-success rounded-circle"
                              title="New Session"
                              type="button">
                        <i class="fas fa-square-plus"></i>
                      </button>
                      <button id="rename-session-btn"
                              class="btn btn-sm btn-outline-secondary rounded-circle"
                              title="Rename Session"
                              type="button">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button id="chat-log-save_button"
                              type="button"
                              class="btn btn-sm btn-outline-secondary rounded-circle"
                              title="Save Chat Log"
                              type="button">
                        <i class="fas fa-file-export"></i>
                      </button>
                    </div>
                    <div class="m-1 d-flex">
                      <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary rounded dropdown-toggle "
                                type="button"
                                id="modelDropdown"
                                data-bs-toggle="dropdown"
                                aria-expanded="false">
                          <span id="current-model-name">Model</span>
                        </button>
                        <ul class="dropdown-menu"
                            id="models-list"
                            aria-labelledby="modelDropdown">
                          <!-- Models will be populated here -->
                        </ul>
                      </div>
                      <div class="dropdown mx-1">
                        <button class="btn btn-sm btn-outline-primary rounded dropdown-toggle"
                                type="button"
                                id="sessionDropdown"
                                data-bs-toggle="dropdown"
                                aria-expanded="false">
                          <span id="current-session-name">Current Session</span>
                        </button>
                        <ul class="dropdown-menu"
                            id="sessions-list"
                            aria-labelledby="sessionDropdown">
                          <!-- Sessions will be populated here -->
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- New Session Modal -->
      <div class="modal fade"
           id="newSessionModal"
           tabindex="-1"
           aria-labelledby="newSessionModalLabel"
           aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="newSessionModalLabel">Create New Session</h5>
              <button type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="new-session-name" class="form-label">Session Name</label>
                <input type="text"
                       class="form-control"
                       id="new-session-name"
                       placeholder="Enter session name">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="create-session-btn">Create</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Rename Session Modal -->
      <div class="modal fade"
           id="renameSessionModal"
           tabindex="-1"
           aria-labelledby="renameSessionModalLabel"
           aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="renameSessionModalLabel">Rename Session</h5>
              <button type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="rename-session-name" class="form-label">New Session Name</label>
                <input type="text"
                       class="form-control"
                       id="rename-session-name"
                       placeholder="Enter new session name">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="save-rename-btn">Save</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Delete Session Modal -->
      <div class="modal fade"
           id="deleteSessionModal"
           tabindex="-1"
           aria-labelledby="deleteSessionModalLabel"
           aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteSessionModalLabel">Delete Session</h5>
              <button type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>
                Are you sure you want to delete the session "<span id="delete-session-name"></span>"?
              </p>
              <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Tool info modal -->
      <div class="modal fade"
           id="toolInfoModal"
           tabindex="-1"
           aria-labelledby="toolInfoModalLabel"
           aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="toolInfoModalLabel">Tool Info</h5>
              <button type="button"
                      class="btn-close"
                      data-bs-dismiss="modal"
                      aria-label="Close"></button>
            </div>
            <div class="modal-body" id="tool-info-body"></div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
  {% if not show_form %}
    <script src={% static "js/chat.js" %}></script>
  {% endif %}
{% endblock content %}
